---
title: "Virginia Department of Health"
output: 
  flexdashboard::flex_dashboard:
    self_contained: FALSE
    favicon: "https://www.vdh.virginia.gov/content/themes/vdh-shared/assets/images/icon.png"
    logo: "https://www.developer.virginia.gov/media/developer/resources/brand/banner/latest/cardinal.svg"
    orientation: rows
    vertical_layout: fill
    mathjax: null
    resize_reload: FALSE
    theme:
      version: 4
      bg: "#FFF"
      fg: "#191919" 
      primary: "#ED79F9"
      navbar-bg: "#141E3C"
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(htmltools)
library(jsonlite)
library(sf)
library(leaflet)
library(echarts4r)

# run to update assets if needed
# source('preprocess.R')

# load assets
scales <- c("Health District" = "district", County = "county", "Census Tract" = "tract")
measures <- read_json("assets/measures.json")
shapes <- lapply(scales, function(s) read_sf(paste0("assets/", s, ".geojson")))
features <- lapply(scales, function(s) read.csv(paste0("assets/", s, ".csv")))
locations <- lapply(features, function(l) {
  ids <- sort(unique(l$id))
  r <- lapply(ids, function(id) {
    l[which(l$id == id)[1], colnames(l) %in% c(
      "name", "id", "region_type", "county_type", "health_district", "healthDistrict", "county_name", "tract_name"
    ), drop = TRUE]
  })
  names(r) <- ids
  r$levels <- c("All", vapply(r, "[[", "", "name"))
  r
})

# variables to build UI with
year_range <- range(features$`Health District`$year)

input_select <- function(label, options, id = paste0("select_", gsub("\\s", "", label)), ...){
  tags$div(
    tags$label(label, `for` = id),
    tags$select(
      id = id,
      class = "custom-select",
      ...,
      lapply(options, function(v) tags$option(value = v, v))
    )
  )
}
```

```{r send_assets}
# add assets to JavaScript
tags$script(paste0(
  "const features = ", toJSON(lapply(features, function(s) {
    split(s[, !colnames(s) %in% c(
      "name", "health_district", "county_name", "tract_name",
      "id", "fid", "county_id", "census_tract_fips", "hd_rural",
      "region_type", "HealthDistrict", "srhp_rural", "state_name"
    )], s$id)
  }), dataframe = "columns", auto_unbox = TRUE),
  ", measures = ", paste(readLines("assets/measures.json"), collapse = ""),
  ", locations = ", toJSON(locations, auto_unbox = TRUE),
  ", meta = ", toJSON(list(year_range = year_range), auto_unbox = TRUE)
))

# include script (handles interactions and updates)
tags$script(src = "script.js")

# custom styling
tags$style(
  type = "text/css",
  paste0(c(
    ".sidebar label{margin: .7em 0 .2em 0}",
    "#select_year{padding: .5em}",
    "#select_year label, #select_year input{cursor: pointer}",
    ".form-check{padding: 0 .5em .5em .7em}",
    ".hidden{display: none}",
    ".form-check-input{position: relative; margin-left: 0}"
  ), collapse = "\n")
)
```

Inputs {.sidebar}
-
```{r menu}
div(
  id = "menu",
  tags$h2("Location"),
  tags$label("Region Type", `for` = "select_scale"),
  div(
    id = "select_scale",
    class = "btn-group btn-group-toggle",
    style = "width: 100%",
    "data-toggle" = "buttons",
    lapply(names(scales)[-3], function(s) {
      tags$label(
        class = "btn btn-default",
        tags$input(type = "radio", onclick = paste0("interactions.change_region('", s, "')"), s)
      )
    })
  ),
  lapply(names(scales)[-3], function(s) {
    tags$div(
      class = "hidden",
      tags$label(s, `for` = paste0("select_", scales[[s]])),
      div(
        class = "input-group mb-3",
        tags$select(
          id = paste0("select_", scales[[s]]),
          class = "custom-select",
          role = "group",
          onchange = paste0("interactions.change_selection(this, '", s, "')"),
          lapply(locations[[s]]$levels, function(v) tags$option(value = v, v))
        ),
        div(
          class = "input-group-append",
          tags$button(
            class = "btn btn-outline-default",
            type = "button",
            onclick = paste0("interactions.reset_", if (s == "County") "county" else "district", "()"),
            "Reset"
          )
        )
      )
    )
  }),
  input_select("Resolution", names(scales), id = "select_shapes", onchange = "interactions.change_shapes(this)"),
  
  tags$h2("Time"),
  input_select("Focal Year", seq(year_range[1], year_range[2]), id = "select_year", onchange = "interactions.change_year(this)"),
  
  tags$h2("Data"),
  input_select("Variable", names(measures), id = "select_variable", onchange = "interactions.change_variable(this)")
)
```

Row
-
### Location
```{r map}
# build map
make_label <- function(scale, data) {
  lapply(with(data, paste0(
    paste("<strong>Health District:</strong>", health_district),
    if (scale != "Health District") paste("<br /><strong>County:</strong>", county_name),
    if (scale == "Census Tract") paste("<br /><strong>Census Tract:</strong>", tract_name)
  )), HTML)
}

colors <- c(
  "#ffffe5", "#fff7bc", "#fee391", "#fec44f", "#fe9929",
  "#ec7014", "#cc4c02", "#993404", "#662506"
)
pal <- function(v) {
  colors[ceiling(v / .15) + 1]
}
attr(pal, "colorType") <- "quantile"
attr(pal, "colorArgs") <- list(probs = seq(0, 1, length = 9), na.color = "#808080")

map <- leaflet(options = leafletOptions(attributionControl = FALSE)) |>
  addProviderTiles("CartoDB.Positron") |>
  setView(-79.7, 38, zoom = 7) |>
  addLegend(
    "bottomleft", pal, c(0, 1),
    title = "Health Access Score",
    opacity = 0.7,
    na.label = "Not Available",
    layerId = "legend"
  )

## add all polygon layers
for (scale in names(scales)) {
  map <- addPolygons(
    map,
    data = shapes[[scale]],
    group = scale,
    fillOpacity = 0.7,
    stroke = TRUE,
    smoothFactor = 0.7,
    weight = 0.5,
    color = "#202020",
    labelOptions = list(textsize = 14),
    label = make_label(scale, shapes[[scale]]),
    layerId = ~id
  )
}

# render map
map
```

Row
-
### Breakdown
```{r plot}
# prepare data for initial plot
grouped_data <- group_by(features$`Health District`, name)
grouped_data$year <- as.factor(grouped_data$year)
year_data <- grouped_data[grouped_data$year == 2019, ]
rank_2019 <- order(year_data$health_access)
grouped_data <- grouped_data[
  grouped_data$name %in% year_data[c(rank_2019[1:5], rank_2019[1:5 + length(rank_2019) - 5]), "name", drop = TRUE],
]

e_charts(grouped_data, year) |>
  e_color(unname(vapply(unique(grouped_data$name), function(n) {
    pal(
      grouped_data[grouped_data$name == n & grouped_data$year == 2019, "health_access", drop = TRUE]
    )
  }, ""))) |>
  e_line(health_access, legend = FALSE) |>
  e_title(
    "Extremes on Map",
    "Top 10 Regions",
    right = "center"
  ) |>
  e_text_g(
    type = "text",
    bottom = 10,
    right = "center",
    style = list(
      text = "Year",
      fontSize = 14
    )
  ) |>
  e_tooltip(
    "axis",
    order = "valueDesc",
    appendToBody = TRUE,
    transitionDuration = 0,
    confine = TRUE
  )
```
