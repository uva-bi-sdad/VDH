---
title: "Virginia Department of Health"
output: 
  flexdashboard::flex_dashboard:
    self_contained: FALSE
    favicon: "https://www.vdh.virginia.gov/content/themes/vdh-shared/assets/images/icon.png"
    logo: "https://www.developer.virginia.gov/media/developer/resources/brand/banner/latest/cardinal.svg"
    orientation: rows
    vertical_layout: fill
    mathjax: null
    resize_reload: FALSE
    theme:
      version: 4
      bg: "#FFF"
      fg: "#191919" 
      primary: "#ED79F9"
      navbar-bg: "#141E3C"
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(htmltools)
library(jsonlite)
library(sf)
library(leaflet)
library(plotly)
source("ui_helpers.R")

# run to update assets if needed
# source('preprocess.R')

# load assets
scales <- c(district = "Health District", county = "County", tract = "Census Tract")
scale_variables <- c(district = "health_district", county = "county_name", tract = "tract_name")
measures <- read_json("assets/measures.json")
shapes <- lapply(names(scales), function(s) read_sf(paste0("assets/", s, ".geojson")))
names(shapes) <- names(scales)
features <- lapply(names(scales), function(s) read.csv(paste0("assets/", s, ".csv")))
names(features) <- names(scales)
locations <- lapply(features, function(l) {
  ids <- sort(unique(l$id))
  r <- lapply(ids, function(id) {
    l[which(l$id == id)[1], colnames(l) %in% c(
      "name", "id", "region_type", "county_type", "health_district", "healthDistrict", "county_name", "tract_name"
    ), drop = TRUE]
  })
  names(r) <- ids
  r$levels <- c("All", vapply(r, "[[", "", "name"))
  r
})

# variables to build UI with
year_range <- range(features$district$year)
year_seq <- seq(year_range[1], year_range[2])
nyears <- year_range[2] - year_range[1] + 1
```

```{r send_assets}
# add assets to JavaScript
tags$script(paste0(
  "const features = ", paste(readLines("assets/data.json"), collapse = ""),
  ", measures = ", paste(readLines("assets/measures.json"), collapse = ""),
  ", locations = ", toJSON(locations, auto_unbox = TRUE),
  ", meta = ", toJSON(list(
    year_range = year_range,
    locations = as.list(structure(names(scales), names = scales))
  ), auto_unbox = TRUE)
))

# include script (handles interactions and updates)
tags$script(src = "script.js")

# custom styling
tags$style(
  type = "text/css",
  paste0(c(
    ".sidebar label{margin: .7em 0 .2em 0}",
    "label.form-check-label{margin: 0}",
    "#select_year label, #select_year input{cursor: pointer}",
    ".form-check{padding: 0 .5em .5em .7em}",
    ".hidden{display: none}",
    ".form-check-input{position: relative; margin-left: 0}"
  ), collapse = "\n")
)
```

Inputs {.sidebar}
-
```{r menu}
div(
  id = "menu",
  h2("Location"),
  input_buttongroup("Region Type", names(scales[-3]), display = scales[-3], id = "select_scale"),
  lapply(names(scales[-3]), function(s) {
    div(
      class = "hidden",
      input_select(
        scales[[s]],
        locations[[s]]$levels,
        condition = "select_scale",
        variable = scale_variables[[s]],
        id = s,
        value = s,
        reset_button = TRUE
      )
    )
  }),
  input_select("Resolution", names(scales), display = scales, id = "select_shapes"),
  h2("Time"),
  input_radio(
    "Focal Year", seq(year_range[1], year_range[2]),
    variable = "year", default = year_range[2], id = "select_year"
  ),
  h2("Data"),
  input_select("Variable", names(measures), display = vapply(measures, "[[", "", "name"), id = "select_variable")
)
```

Row
-
### Location
```{r map}
# build map
make_label <- function(scale, data) {
  lapply(with(data, paste0(
    paste("<strong>Health District:</strong>", health_district),
    if (scale != "district") paste("<br /><strong>County:</strong>", county_name),
    if (scale == "tract") paste("<br /><strong>Census Tract:</strong>", tract_name)
  )), HTML)
}

colors <- c(
  "#FFD67E", "#F0C471", "#E1B265", "#D3A158", "#C48F4C", "#B57D3F", "#A76C33", "#985A26", "#89481A", "#7B370E"
)
pal <- function(v) {
  colors[ceiling(v / .15) + 1]
}
attr(pal, "colorType") <- "quantile"
attr(pal, "colorArgs") <- list(probs = seq(0, 1, length = 9), na.color = "#808080")

map <- leaflet(options = leafletOptions(attributionControl = FALSE)) |>
  addProviderTiles("CartoDB.Positron") |>
  setView(-79.7, 38, zoom = 7) |>
  addLegend(
    "bottomleft", pal, c(0, 1),
    title = "Health Access Score",
    opacity = 0.7,
    na.label = "Not Available",
    layerId = "legend"
  )

## add all polygon layers
for (scale in names(scales)) {
  map <- addPolygons(
    map,
    data = shapes[[scale]],
    group = scale,
    fillOpacity = 0.7,
    stroke = TRUE,
    smoothFactor = 0.7,
    weight = 0.5,
    color = "#202020",
    labelOptions = list(textsize = 14),
    label = make_label(scale, shapes[[scale]]),
    layerId = ~id
  )
}

# render map
map
```

Row
-
### Breakdown
```{r plot}
# prepare data for initial plot
grouped_data <- group_by(features$district, name)
grouped_data$year <- as.factor(grouped_data$year)
year_data <- grouped_data[grouped_data$year == 2019, ]
rank_2019 <- order(year_data$health_access)
top_data <- grouped_data[
  grouped_data$name %in% year_data[c(rank_2019[1:5], rank_2019[1:5 + length(rank_2019) - 5]), "name", drop = TRUE],
]
top_data$year_data <- rep(
  top_data[top_data$year == 2019, "health_access", drop = TRUE],
  each = year_range[2] - year_range[1] + 1
)

plot_ly(
  top_data,
  x = ~year,
  y = ~health_access,
  text = ~name,
  hoverinfo = "text",
  type = "scatter",
  color = ~name,
  colors = ~ pal(year_data),
  mode = "lines+markers",
  showlegend = FALSE
) |>
  add_trace(
    name = "Box Plot",
    inherit = FALSE,
    data = grouped_data,
    type = "box",
    x = ~year,
    y = ~health_access,
    fillcolor = "transparent",
    line = list(color = "#d6d6d6")
  ) |>
  layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE)) |>
  config(displayModeBar = FALSE, showTips = FALSE)
```
